var G=(g,f,x)=>new Promise((q,u)=>{var h=i=>{try{p(x.next(i))}catch(v){u(v)}},n=i=>{try{p(x.throw(i))}catch(v){u(v)}},p=i=>i.done?q(i.value):Promise.resolve(i.value).then(h,n);p((x=x.apply(g,f)).next())});import{d as ae,$ as X,j as S,a1 as P,ad as ie,d5 as z,J as oe,r as o,o as b,c as A,u as s,D as R,w as e,b as t,e as l,n as c,F as J,aN as de,bt as _e,ac as Z,s as fe,x as pe,h as ne,ae as me,c$ as ve,aM as ge,cZ as he,aL as ye,aP as we,b5 as be,Q as K,q as W,t as U,U as Y,bl as xe,a6 as Ce}from"./index-3efa3bcd.js";import{d as ee}from"./chartEditStore-1e6a587f.js";import{i as B}from"./icon-f6cbc454.js";import{T as H,D as $}from"./index-9ba8d76c.js";import{u as le}from"./useTargetData.hook-4df2987a.js";import{M as Se}from"./EditorWorker-1ca10225.js";import"./editorWorker-02e2e6ec.js";import{g as ke}from"./plugin-52ae8d1b.js";import{F as te}from"./fileTypeEnum-21359a08.js";const Q=g=>(fe("data-v-8db15d87"),g=g(),pe(),g),Fe=Q(()=>c("p",null,[c("span",{class:"func-keyword"},"function"),l("  filter(data, res)  {")],-1)),Te={class:"go-ml-4"},qe=Q(()=>c("p",null,"}",-1)),Re=Q(()=>c("span",{class:"func-keyword"},"function",-1)),Ee={class:"editor-data-show"},je={class:"editor-data-show"},Ie={class:"editor-data-show"},Le={class:"go-flex-items-center"},De=ae({__name:"index",setup(g){const{DocumentTextIcon:f}=B.ionicons5,{FilterIcon:x,FilterEditIcon:q}=B.carbon,{targetData:u,chartEditStore:h}=le();X(u.value.request),X(h.getRequestGlobalConfig);const n=S(!1),p=S(u.value.filter||"return data"),i=S(!1),v=S(""),E=()=>G(this,null,function*(){try{u.value.request.requestSQLContent.action="ListData",u.value.request.requestSQLContent.id=u.value.id,u.value.request.requestSQLContent.projectId=de();const m=yield _e(Z(u.value.request),Z(h.getRequestGlobalConfig));if(m){v.value=m;return}window.$message.warning("没有拿到返回值，请检查接口！")}catch(m){console.error(m),window.$message.warning("数据异常，请检查参数！")}}),M=P(()=>{try{const m=new Function("data","res",p.value),y=ie(v.value),a=m(y==null?void 0:y.data,y);return i.value=!1,z(a)}catch(m){return i.value=!0,`过滤函数错误，日志：${m}`}}),I=()=>{n.value=!0},O=()=>{ke({message:"是否删除过滤器",onPositiveCallback:()=>{u.value.filter=void 0}})},L=()=>{n.value=!1},D=()=>{if(i.value){window.$message.error("过滤函数错误，无法进行保存");return}u.value.filter=p.value,L()};return oe(()=>n.value,m=>{m&&(E(),p.value=u.value.filter||"return data")}),(m,y)=>{const a=o("n-code"),r=o("n-icon"),_=o("n-button"),d=o("n-space"),C=o("n-card"),F=o("n-text"),T=o("n-tag"),j=o("n-divider"),N=o("n-scrollbar"),V=o("n-modal");return b(),A(J,null,[s(u).filter?(b(),R(C,{key:0},{footer:e(()=>[t(d,{justify:"end"},{default:e(()=>[t(_,{type:"primary",tertiary:"",size:"small",onClick:I},{icon:e(()=>[t(r,null,{default:e(()=>[t(s(q))]),_:1})]),default:e(()=>[l(" 编辑 ")]),_:1}),t(_,{tertiary:"",size:"small",onClick:O},{default:e(()=>[l(" 删除 ")]),_:1})]),_:1})]),default:e(()=>[Fe,c("div",Te,[t(a,{code:s(u).filter,language:"typescript"},null,8,["code"])]),qe]),_:1})):(b(),R(_,{key:1,class:"go-ml-3",onClick:I},{icon:e(()=>[t(r,null,{default:e(()=>[t(s(x))]),_:1})]),default:e(()=>[l(" 新增过滤器 ")]),_:1})),t(V,{class:"go-chart-data-monaco-editor",show:n.value,"onUpdate:show":y[1]||(y[1]=k=>n.value=k),"mask-closable":!1,closeOnEsc:!1},{default:e(()=>[t(C,{bordered:!1,role:"dialog",size:"small","aria-modal":"true",style:{width:"1000px",height:"600px"}},{header:e(()=>[t(d,null,{default:e(()=>[t(F,null,{default:e(()=>[l("过滤器函数编辑器")]),_:1})]),_:1})]),"header-extra":e(()=>[]),action:e(()=>[t(d,{justify:"space-between"},{default:e(()=>[c("div",Le,[t(T,{bordered:!1,type:"primary"},{icon:e(()=>[t(r,{component:s(f)},null,8,["component"])]),default:e(()=>[l(" 规则 ")]),_:1}),t(F,{class:"go-ml-2",depth:"2"},{default:e(()=>[l("过滤器默认处理接口返回值的「data」字段")]),_:1})]),t(d,null,{default:e(()=>[t(_,{size:"medium",onClick:L},{default:e(()=>[l("取消")]),_:1}),t(_,{size:"medium",type:"primary",onClick:D},{default:e(()=>[l("保存")]),_:1})]),_:1})]),_:1})]),default:e(()=>[t(d,{size:"small",vertical:""},{default:e(()=>[t(d,{justify:"space-between"},{default:e(()=>[c("div",null,[t(d,{vertical:""},{default:e(()=>[t(T,{type:"info"},{default:e(()=>[Re,l("  filter(data, res)  { ")]),_:1}),t(s(Se),{modelValue:p.value,"onUpdate:modelValue":y[0]||(y[0]=k=>p.value=k),width:"460px",height:"380px",language:"javascript"},null,8,["modelValue"]),t(T,{type:"info"},{default:e(()=>[l("}")]),_:1})]),_:1})]),t(j,{vertical:"",style:{height:"480px"}}),t(N,{style:{"max-height":"480px"}},{default:e(()=>[t(d,{size:15,vertical:""},{default:e(()=>[c("div",Ee,[t(d,null,{default:e(()=>{var k;return[t(F,{depth:"3"},{default:e(()=>[l("默认过滤数据(data)：")]),_:1}),t(a,{code:s(z)((k=v.value)==null?void 0:k.data)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]}),_:1})]),c("div",je,[t(d,null,{default:e(()=>[t(F,{depth:"3"},{default:e(()=>[l("接口返回数据(res)：")]),_:1}),t(a,{code:s(z)(v.value)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),c("div",Ie,[t(d,null,{default:e(()=>[t(F,{depth:"3"},{default:e(()=>[l("过滤器结果：")]),_:1}),t(a,{code:M.value||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])],64)}}});const Ne=ne(De,[["__scopeId","data-v-8db15d87"]]),Ue=g=>{const f=S();return{uploadFileListRef:f,beforeUpload:({file:h})=>{f.value=[];const n=h.file.type;return n!==te.JSON&&n!==te.TXT?(window.$message.warning("仅支持上传 【JSON】 格式文件，请重新上传！"),!1):!0},customRequest:h=>{const{file:n}=h;me(()=>{n.file?ve(n.file).then(p=>{g.value.option.dataset=ge(p)}):window.$message.error("导入数据失败，请稍后重试或联系管理员！")})},download:()=>{try{window.$message.success("下载中，请耐心等待..."),he(ye(g.value.option.dataset),void 0,"json")}catch(h){window.$message.error("下载失败，数据错误！")}}}},$e=ae({__name:"index",props:{show:{type:Boolean,required:!1},ajax:{type:Boolean,required:!0}},setup(g){const{targetData:f}=le(),x=["字段","映射","状态"],{HelpOutlineIcon:q}=B.ionicons5,{DocumentAddIcon:u,DocumentDownloadIcon:h}=B.carbon,n=S(),p=S(),i=S(),v=S(!1),{uploadFileListRef:E,customRequest:M,beforeUpload:I,download:O}=Ue(f),L=P(()=>f.value.request.requestDataType!==we.STATIC),D=P(()=>f.value.chartConfig.chartFrame===ee.ECHARTS),m=a=>{let r=$.SUCCESS;for(let _=0;_<n.value.length;_++)if(n.value[_][a]===void 0)return r=$.FAILURE,r;return $.SUCCESS},y=()=>{try{return p.value.map((a,r)=>r===0?{field:"通用标识",mapping:a,result:$.NULL}:{field:`数据项-${r}`,mapping:a,result:m(a)})}catch(a){return[]}};return oe(()=>{var a,r;return(r=(a=f.value)==null?void 0:a.option)==null?void 0:r.dataset},a=>{var r,_;a&&((_=(r=f==null?void 0:f.value)==null?void 0:r.chartConfig)==null?void 0:_.chartFrame)===ee.ECHARTS?(n.value=a,D.value&&(p.value=a.dimensions,i.value=y())):a!=null?(i.value=null,n.value=a):(v.value=!0,n.value="此组件无数据源"),be(a)&&(i.value=null)},{immediate:!0}),(a,r)=>{const _=o("n-badge"),d=o("n-text"),C=o("n-space"),F=o("n-table"),T=o("n-timeline-item"),j=o("n-icon"),N=o("n-button"),V=o("n-upload"),k=o("n-tooltip"),se=o("n-code"),ue=o("n-card"),re=o("n-timeline");return b(),R(re,{class:"go-chart-configurations-timeline"},{default:e(()=>[K(t(T,{type:"info",title:s(H).MAPPING},{default:e(()=>[t(F,{striped:""},{default:e(()=>[c("thead",null,[c("tr",null,[(b(),A(J,null,W(x,w=>c("th",{key:w},U(w),1)),64))])]),c("tbody",null,[(b(!0),A(J,null,W(i.value,(w,ce)=>(b(),A("tr",{key:ce},[c("td",null,U(w.field),1),c("td",null,U(w.mapping),1),c("td",null,[w.result===0?(b(),R(C,{key:0},{default:e(()=>[t(_,{dot:"",type:"success"}),t(d,null,{default:e(()=>[l("无")]),_:1})]),_:1})):(b(),R(C,{key:1},{default:e(()=>[t(_,{dot:"",type:w.result===1?"success":"error"},null,8,["type"]),t(d,null,{default:e(()=>[l("匹配"+U(w.result===1?"成功":"失败"),1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})]),_:1},8,["title"]),[[Y,D.value&&i.value]]),K(t(T,{color:"#97846c",title:s(H).FILTER},{default:e(()=>[t(C,{size:18,vertical:""},{default:e(()=>[t(d,{depth:"3"},{default:e(()=>[l("过滤器默认处理接口返回值的「data」字段")]),_:1}),t(s(Ne))]),_:1})]),_:1},8,["title"]),[[Y,L.value]]),t(T,{type:"success",title:s(H).CONTENT},{default:e(()=>[t(C,{vertical:""},{default:e(()=>[t(C,{class:"source-btn-box"},{default:e(()=>[t(V,{"file-list":s(E),"onUpdate:fileList":r[0]||(r[0]=w=>xe(E)?E.value=w:null),"show-file-list":!1,customRequest:s(M),onBeforeUpload:s(I)},{default:e(()=>[t(C,null,{default:e(()=>[g.ajax?Ce("",!0):(b(),R(N,{key:0,class:"sourceBtn-item",disabled:v.value},{icon:e(()=>[t(j,null,{default:e(()=>[t(s(u))]),_:1})]),default:e(()=>[l(" 导入（json / txt） ")]),_:1},8,["disabled"]))]),_:1})]),_:1},8,["file-list","customRequest","onBeforeUpload"]),c("div",null,[t(N,{class:"sourceBtn-item",disabled:v.value,onClick:s(O)},{icon:e(()=>[t(j,null,{default:e(()=>[t(s(h))]),_:1})]),default:e(()=>[l(" 下载 ")]),_:1},8,["disabled","onClick"]),t(k,{trigger:"hover"},{trigger:e(()=>[t(j,{class:"go-ml-1",size:"21",depth:3},{default:e(()=>[t(s(q))]),_:1})]),default:e(()=>[t(d,{depth:"3"},{default:e(()=>[l("点击【下载】查看完整数据")]),_:1})]),_:1})])]),_:1}),t(ue,{size:"small"},{default:e(()=>[t(se,{code:s(z)(n.value),language:"json"},null,8,["code"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})}}});const Ge=ne($e,[["__scopeId","data-v-ef52326b"]]);export{Ge as C};

var B=Object.defineProperty,D=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var _=(t,e,n)=>e in t?B(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,U=(t,e)=>{for(var n in e||(e={}))H.call(e,n)&&_(t,n,e[n]);if(F)for(var n of F(e))J.call(e,n)&&_(t,n,e[n]);return t},y=(t,e)=>D(t,G(e));var g=(t,e,n)=>new Promise((s,T)=>{var A=c=>{try{v(n.next(c))}catch(o){T(o)}},I=c=>{try{v(n.throw(c))}catch(o){T(o)}},v=c=>c.done?s(c.value):Promise.resolve(c.value).then(A,I);v((n=n.apply(t,e)).next())});import{k as K,ax as j,aN as h,a_ as l,cF as q,cG as W,R as P,aL as X,L as w,aM as b,a9 as z,cH as Q,a2 as Y,cx as R,aW as L,aX as O}from"./index-3efa3bcd.js";import{u as Z,a as tt,P as E,f as u,C as et,g as at}from"./chartEditStore-1e6a587f.js";import{u as ot,C as V}from"./chartLayoutStore-db3d2e1b.js";import{f as nt,d as rt,e as it}from"./index-a77faccb.js";import{e as st,u as $,s as dt,f as ft}from"./project.api-31a95c84.js";const ct=t=>t,St=(t,e)=>{try{if(e.id){const n="vnodeBeforeMount"in e.events,s="vnodeMounted"in e.events;return n&&(t.events.advancedEvents.vnodeBeforeMount=e==null?void 0:e.events.vnodeBeforeMount),s&&(t.events.advancedEvents.vnodeMounted=e==null?void 0:e.events.vnodeMounted),(n||s)&&(e.events={baseEvent:{[L.ON_CLICK]:void 0,[L.ON_DBL_CLICK]:void 0,[L.ON_MOUSE_ENTER]:void 0,[L.ON_MOUSE_LEAVE]:void 0},advancedEvents:{[O.VNODE_MOUNTED]:void 0,[O.VNODE_BEFORE_MOUNT]:void 0},interactEvents:[]}),t}}catch(n){return t}},m=(t,e,n=!1)=>{if(St(t,e),n)return R(t,e);const s=e.option;if(!s)return R(t,e);if(e.option=void 0,s)return y(U({},R(t,e)),{option:s})},pt=()=>{const t=Z(),e=tt(),n=K(),s=ot(),T=(o,S=!1,f=!1)=>g(void 0,null,function*(){S&&(t.componentList=[],e.clearBackStack(),e.clearForwardStack()),o.editCanvasConfig=ct(o.editCanvasConfig),o.componentList.forEach(a=>g(void 0,null,function*(){const i=r=>{window.$vue.component(r.chartConfig.chartKey)||(window.$vue.component(r.chartConfig.chartKey,nt(r.chartConfig)),window.$vue.component(r.chartConfig.conKey,rt(r.chartConfig)))};a.isGroup?a.groupList.forEach(r=>{i(r)}):i(a)}));const C=(a,i)=>g(void 0,null,function*(){let r=yield it(a.chartConfig);a.chartConfig.redirectComponent&&(a.chartConfig.dataset&&(r.option.dataset=a.chartConfig.dataset),r.chartConfig.title=a.chartConfig.title,r.chartConfig.chartFrame=a.chartConfig.chartFrame),i?i(f?m(r,y(U({},a),{id:w()})):m(r,a)):f?t.addComponentList(m(r,y(U({},a),{id:w()})),!1,!0):t.addComponentList(m(r,a),!1,!0)});for(const a in o)if(a===et.COMPONENT_LIST){let i=0;const r=o[a].length;for(const d of o[a]){let N=parseInt((parseFloat(`${++i/r}`)*100).toString());if(s.setItemUnHandle(V.PERCENTAGE,N),d.isGroup){let p=new at;f?p=m(p,y(U({},d),{id:w()})):p=m(p,d);const M=[];for(const k of d.groupList)yield C(k,x=>{M.push(x)});p.groupList=M,t.addComponentList(p,!1,!0)}else yield C(d);N===100&&(e.clearBackStack(),e.clearForwardStack())}}else{if(a!=="editCanvasConfig"&&a!=="requestGlobalConfig")return;m(t[a],o[a],!0)}s.setItemUnHandle(V.PERCENTAGE,0)}),A=o=>{const{id:S,projectName:f,remarks:C,indexImage:a,state:i}=o;t.setProjectInfo(E.PROJECT_ID,S),t.setProjectInfo(E.PROJECT_NAME,f),t.setProjectInfo(E.REMARKS,C),t.setProjectInfo(E.THUMBNAIL,a),t.setProjectInfo(E.RELEASE,i===1)},I=()=>g(void 0,null,function*(){t.componentList=[],t.setEditCanvas(u.SAVE_STATUS,l.START);try{const o=yield ft({projectId:h(),random:Math.random()});if(o&&o.code===P.SUCCESS){if(o.data){A(o.data),yield T(b(o.data.content));return}else t.setProjectInfo(E.PROJECT_ID,h());setTimeout(()=>{t.setEditCanvas(u.SAVE_STATUS,l.SUCCESS)},1e3);return}t.setEditCanvas(u.SAVE_STATUS,l.FAILURE)}catch(o){t.setEditCanvas(u.SAVE_STATUS,l.FAILURE),z()}}),v=j((o=!0)=>g(void 0,null,function*(){if(!h())return;let S=t.getProjectInfo[E.PROJECT_ID];if(S===null||S===""){window.$message.error("数据初未始化成功,请刷新页面！");return}t.setEditCanvas(u.SAVE_STATUS,l.START);try{if(o){const a=document.querySelector(".go-edit-range"),i=yield q(a,{backgroundColor:null,allowTaint:!0,useCORS:!0});let r=new FormData;r.append("object",W(i.toDataURL(),`${h()}_index_preview.png`));const d=yield st(r);d&&d.code===P.SUCCESS&&(d.data.fileurl?yield $({id:h(),indexImage:`${d.data.fileurl}`}):yield $({id:h(),indexImage:`${n.getFetchInfo.OSSUrl}${d.data.fileName}`})),window.$message.success("当前大屏数据保存成功！")}}catch(a){console.log(a)}let f=new FormData;f.append("projectId",S),f.append("content",X(t.getStorageInfo||{}));const C=yield dt(f);if(C&&C.code===P.SUCCESS){setTimeout(()=>{t.setEditCanvas(u.SAVE_STATUS,l.SUCCESS)},1e3);return}t.setEditCanvas(u.SAVE_STATUS,l.FAILURE)}),3e3);return{updateComponent:T,updateStoreInfo:A,dataSyncFetch:I,dataSyncUpdate:v,intervalDataSyncUpdate:()=>{const o=setInterval(()=>{v()},Q*1e3);Y(()=>{clearInterval(o)})}}};export{pt as u};
